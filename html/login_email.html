<!DOCTYPE html>
<html lang="ko-KR">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>login-email</title>

    <link rel="stylesheet" href="../css/reset.css">
    <link rel="stylesheet" href="../css/login_email.css">
</head>

<body>
    <main class="login">
        <h1 class="title">로그인</h1>
        <form>
            <label for="email">이메일</label>
            <input type="email" id="email" required>
            <strong class="warning-msg-1">*이메일 양식에 맞게 아이디를 입력해주세요.</strong>
            <label for="pw">비밀번호</label>
            <input type="password" id="pw" required>
            <strong class="warning-msg-2">*이메일 또는 비밀번호가 일치하지 않습니다.</strong>
            <button id="login-btn" class="size-l" disabled>로그인</button>
            </form>
            <div class="email-join"><a class="join" href="./join_membership.html">이메일로 회원가입</a></div>
    </main>
    <script>
        // todo : 코드 리팩토링, sass 변수 가져오는 법, try catch 문

        const loginButton = document.querySelector('#login-btn');
        const inps = document.querySelectorAll('input');
        const email = document.querySelector('#email');
        const pw = document.querySelector('#pw');

        // 아이디 비밀번호 입력시 로그인 버튼 활성화
        inps.forEach(item => {
            item.addEventListener('keyup', () => {
                if (!email.validity.typeMismatch) {
                    document.querySelector('.warning-msg-1').style.display = 'none';
                    email.style.borderBottom = '1px solid #dbdbdb';
                };
                document.querySelector('.warning-msg-2').style.display = 'none';
                if (!email.validity.valueMissing && !pw.validity.valueMissing) {
                    loginButton.disabled = false
                } else {
                    loginButton.disabled = true
                }
            })
        })

        // 로그인 버튼 클릭시 이메일 형식 유효성 검사
        loginButton.addEventListener('click', (e) => {
            e.preventDefault();
            validate(email);
        })

        function validate(target) {
            if (target.validity.typeMismatch) {
                document.querySelector('.warning-msg-1').style.display = 'block'
                email.style.borderBottom = '1px solid red';
                email.focus()
            } else {
                login();
            }
        }

        // api 연동 
        async function login() {
            const url = "https://api.mandarin.weniv.co.kr";
            const reqPath = "/user/login/";
            console.log(email.value, pw.value)
            const loginData = {
                "user": {
                    "email": email.value,
                    "password": pw.value
                    // "email": 'suritest@test.com',
                    // "password": 'suritest'
                }
            }
            const res = await fetch(url + reqPath, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ ...loginData })
            })
            const json = await res.json()
            console.log(json, "제이손입니다")

            if (json.status !== 422) { // 로그인 성공
                console.log(json.user.token)
                localStorage.setItem("user", json.user.token);
                location.href = './home.html';
            } else {
                document.querySelector('.warning-msg-2').style.display = 'block';
            }
        }

    </script>
</body>

</html>